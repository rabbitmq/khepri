<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module khepri_machine</title>
<link rel="stylesheet" type="text/css" href="edoc-extensions.css" title="EDoc">
<link rel="icon" href="khepri-favicon.svg" type="image/svg+xml">
</head>
<body class="markdown-body language-erlang"><script src="prism.js"></script>
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module khepri_machine</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#types">Data Types</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>  
Khepri private low-level API.

<p><b>Behaviours:</b> <a href="ra_machine.html"><code>ra_machine</code></a>.</p>

<h2><a name="description">Description</a></h2><p>  
Khepri private low-level API.</p>
 
  <p>This module exposes the private "low-level" API to the Khepri database and
  state machine. Main functions correspond to Ra commands implemented by the
  state machine. All functions in <a docgen-rel="seeerl" docgen-href="khepri" href="khepri.html"><code>khepri</code></a> are built on top of this  
module.</p>
 
  This module is private. The documentation is still visible because it may
  help understand some implementation details. However, this module should
  never be called directly outside of Khepri.
<h2><a name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-async_ret">async_ret()</a></h3>
<p><code>async_ret() = ok</code></p>


<h3 class="typedecl"><a name="type-common_ret">common_ret()</a></h3>
<p><code>common_ret() = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-ok">khepri:ok</a>(<a href="/home/runner/work/khepri/khepri/doc/khepri_adv.html#type-node_props_map">khepri_adv:node_props_map()</a>) | <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-error">khepri:error()</a></code></p>


<h3 class="typedecl"><a name="type-keep_while_conds_map">keep_while_conds_map()</a></h3>
<p><code>keep_while_conds_map() = #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_path">khepri_path:native_path()</a> =&gt; <a href="/home/runner/work/khepri/khepri/doc/khepri_condition.html#type-native_keep_while">khepri_condition:native_keep_while()</a>}</code></p>
<p>  Per-node <code>keep_while</code> conditions.</p>

<h3 class="typedecl"><a name="type-keep_while_conds_revidx">keep_while_conds_revidx()</a></h3>
<p><code>keep_while_conds_revidx() = #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_path">khepri_path:native_path()</a> =&gt; #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_path">khepri_path:native_path()</a> =&gt; ok}}</code></p>
<p>  Internal reverse index of the keep_while conditions. If node A depends on a
  condition on node B, then this reverse index will have a "node B =&gt; node A"
  entry.</p>

<h3 class="typedecl"><a name="type-machine_config">machine_config()</a></h3>
<p><code>machine_config() = #config{store_id = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a>, member = <a href="/home/runner/work/khepri/ra/doc/ra.html#type-server_id">ra:server_id()</a>, snapshot_interval = non_neg_integer()}</code></p>
<p>  Configuration record, holding read-only or rarely changing fields.</p>

<h3 class="typedecl"><a name="type-projections_map">projections_map()</a></h3>
<p><code>projections_map() = #{<a href="/home/runner/work/khepri/khepri/doc/khepri_projection.html#type-projection">khepri_projection:projection()</a> =&gt; <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_pattern">khepri_path:native_pattern()</a>}</code></p>
<p>  Internal mapping between <a docgen-rel="seetype" docgen-href="khepri_projection#projection/0" href="khepri_projection.html#type-projection"><code>khepri_projection:projection()</code></a> records and
  the native path patterns which trigger updates to each projection.</p>

<h3 class="typedecl"><a name="type-props">props()</a></h3>
<p><code>props() = #{payload_version := <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-payload_version">khepri:payload_version()</a>, child_list_version := <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-child_list_version">khepri:child_list_version()</a>}</code></p>
<p>  Properties attached to each node in the tree structure.</p>

<h3 class="typedecl"><a name="type-state">state()</a></h3>
<p><code>state() = #khepri_machine{config = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-machine_config">khepri_machine:machine_config()</a>, root = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-tree_node">khepri_machine:tree_node()</a>, keep_while_conds = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-keep_while_conds_map">khepri_machine:keep_while_conds_map()</a>, keep_while_conds_revidx = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-keep_while_conds_revidx">khepri_machine:keep_while_conds_revidx()</a>, triggers = #{<a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-trigger_id">khepri:trigger_id()</a> =&gt; #{sproc := <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_path">khepri_path:native_path()</a>, event_filter := <a href="/home/runner/work/khepri/khepri/doc/khepri_evf.html#type-event_filter">khepri_evf:event_filter()</a>}}, emitted_triggers = [<a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-triggered">khepri_machine:triggered()</a>], projections = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-projections_map">khepri_machine:projections_map()</a>, metrics = #{applied_command_count =&gt; non_neg_integer()}}</code></p>
<p>  State of this Ra state machine.</p>

<h3 class="typedecl"><a name="type-tree_node">tree_node()</a></h3>
<p><code>tree_node() = #node{props = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-props">khepri_machine:props()</a>, payload = <a href="/home/runner/work/khepri/khepri/doc/khepri_payload.html#type-payload">khepri_payload:payload()</a>, child_nodes = #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-component">khepri_path:component()</a> := #node{props = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-props">khepri_machine:props()</a>, payload = <a href="/home/runner/work/khepri/khepri/doc/khepri_payload.html#type-payload">khepri_payload:payload()</a>, child_nodes = #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-component">khepri_path:component()</a> := #node{}}}}}</code></p>
<p>  A node in the tree structure.</p>

<h3 class="typedecl"><a name="type-triggered">triggered()</a></h3>
<p><code>triggered() = #triggered{id = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-trigger_id">khepri:trigger_id()</a>, event_filter = <a href="/home/runner/work/khepri/khepri/doc/khepri_evf.html#type-event_filter">khepri_evf:event_filter()</a>, sproc = <a href="/home/runner/work/khepri/khepri/doc/khepri_fun.html#type-standalone_fun">khepri_fun:standalone_fun()</a>, props = map()}</code></p>


<h3 class="typedecl"><a name="type-tx_ret">tx_ret()</a></h3>
<p><code>tx_ret() = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-ok">khepri:ok</a>(<a href="/home/runner/work/khepri/khepri/doc/khepri_tx.html#type-tx_fun_result">khepri_tx:tx_fun_result()</a>) | <a href="/home/runner/work/khepri/khepri/doc/khepri_tx.html#type-tx_abort">khepri_tx:tx_abort()</a> | no_return()</code></p>


<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#fold-5">fold/5</a></td><td>Returns all tree nodes matching the given path pattern.</td></tr>
<tr><td valign="top"><a href="#delete-3">delete/3</a></td><td>Deletes all tree nodes matching the path pattern.</td></tr>
<tr><td valign="top"><a href="#transaction-5">transaction/5</a></td><td>Runs a transaction and returns the result.</td></tr>
<tr><td valign="top"><a href="#handle_tx_exception-1">handle_tx_exception/1</a></td><td></td></tr>
<tr><td valign="top"><a href="#register_trigger-5">register_trigger/5</a></td><td>Registers a trigger.</td></tr>
<tr><td valign="top"><a href="#register_projection-4">register_projection/4</a></td><td>Registers a projection.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="fold-5">fold/5</a></h3>
<div class="spec">
<p><code>fold(StoreId, PathPattern, Fun, Acc, Options) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>PathPattern = <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern">khepri_path:pattern()</a></code></li><li><code>Fun = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-fold_fun">khepri:fold_fun()</a></code></li><li><code>Acc = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-fold_acc">khepri:fold_acc()</a></code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-query_options">khepri:query_options()</a> | <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-tree_options">khepri:tree_options()</a></code></li><li><code>Ret = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-ok">khepri:ok</a>(NewAcc) | <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-error">khepri:error()</a></code></li><li><code>NewAcc = Acc</code></li></ul></p>
<p><code>StoreId</code>: the name of the Ra cluster.<br>
<code>PathPattern</code>: the path (or path pattern) to the nodes to get.<br>
<code>Options</code>: query options such as <code>favor</code>.
 <br>
</p>
<p>returns: an <code>{ok, NodePropsMap}</code> tuple with a map with zero, one or more
  entries, or an <code>{error, Reason}</code> tuple.</p>
</div><p>Returns all tree nodes matching the given path pattern.
 </p>

<h3 class="function"><a name="delete-3">delete/3</a></h3>
<div class="spec">
<p><code>delete(StoreId, PathPattern, Options) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>PathPattern = <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern">khepri_path:pattern()</a></code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-command_options">khepri:command_options()</a> | <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-tree_options">khepri:tree_options()</a></code></li><li><code>Ret = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-common_ret">khepri_machine:common_ret()</a> | <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-async_ret">khepri_machine:async_ret()</a></code></li></ul></p>
<p><code>StoreId</code>: the name of the Ra cluster.<br>
<code>PathPattern</code>: the path (or path pattern) to the nodes to delete.<br>
<code>Options</code>: command options such as the command type.
 <br>
</p>
<p>returns: in the case of a synchronous delete, an <code>{ok, NodePropsMap}</code> tuple
  with a map with zero, one or more entries, or an <code>{error, Reason}</code> tuple;
  in the case of an asynchronous put, always <code>ok</code> (the actual return value
  may be sent by a message if a correlation ID was specified).</p>
</div><p>Deletes all tree nodes matching the path pattern.
 </p>

<h3 class="function"><a name="transaction-5">transaction/5</a></h3>
<div class="spec">
<p><code>transaction(StoreId, FunOrPath, Args, ReadWrite, Options) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>FunOrPath = Fun | PathPattern</code></li><li><code>Fun = <a href="/home/runner/work/khepri/khepri/doc/khepri_tx.html#type-tx_fun">khepri_tx:tx_fun()</a></code></li><li><code>PathPattern = <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern">khepri_path:pattern()</a></code></li><li><code>Args = list()</code></li><li><code>ReadWrite = ro | rw | auto</code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-command_options">khepri:command_options()</a> | <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-query_options">khepri:query_options()</a></code></li><li><code>Ret = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-tx_ret">khepri_machine:tx_ret()</a> | <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-async_ret">khepri_machine:async_ret()</a></code></li></ul></p>
<p><code>StoreId</code>: the name of the Ra cluster.<br>
<code>FunOrPath</code>: an arbitrary anonymous function or a path pattern pointing
         to a stored procedure.<br>
<code>Args</code>: a list of arguments to pass to <code>FunOrPath</code>.<br>
<code>ReadWrite</code>: the read/write or read-only nature of the transaction.<br>
<code>Options</code>: command options such as the command type.
 <br>
</p>
<p>returns: in the case of a synchronous transaction, <code>{ok, Result}</code> where
  <code>Result</code> is the return value of <code>FunOrPath</code>, or <code>{error, Reason}</code> if the
  anonymous function was aborted; in the case of an asynchronous transaction,
  always <code>ok</code> (the actual return value may be sent by a message if a
  correlation ID was specified).</p>
</div><p>Runs a transaction and returns the result.
 </p>

<h3 class="function"><a name="handle_tx_exception-1">handle_tx_exception/1</a></h3>
<div class="spec">
<p><code>handle_tx_exception(X1) -&gt; any()</code></p>
<p></p>
</div>

<h3 class="function"><a name="register_trigger-5">register_trigger/5</a></h3>
<div class="spec">
<p><code>register_trigger(StoreId, TriggerId, EventFilter, StoredProcPath, Options) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>TriggerId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-trigger_id">khepri:trigger_id()</a></code></li><li><code>EventFilter = <a href="/home/runner/work/khepri/khepri/doc/khepri_evf.html#type-event_filter">khepri_evf:event_filter()</a> | <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern">khepri_path:pattern()</a></code></li><li><code>StoredProcPath = <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-path">khepri_path:path()</a></code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-command_options">khepri:command_options()</a></code></li><li><code>Ret = ok | <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-error">khepri:error()</a></code></li></ul></p>
<p><code>StoreId</code>: the name of the Ra cluster.<br>
<code>TriggerId</code>: the name of the trigger.<br>
<code>EventFilter</code>: the event filter used to associate an event with a
         stored procedure.<br>
<code>StoredProcPath</code>: the path to the stored procedure to execute when the
         corresponding event occurs.
 <br>
</p>
<p>returns: <code>ok</code> if the trigger was registered, an <code>{error, Reason}</code> tuple
  otherwise.</p>
</div><p>Registers a trigger.
 </p>

<h3 class="function"><a name="register_projection-4">register_projection/4</a></h3>
<div class="spec">
<p><code>register_projection(StoreId, PathPattern, Projection, Options) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>PathPattern = <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern">khepri_path:pattern()</a></code></li><li><code>Projection = <a href="/home/runner/work/khepri/khepri/doc/khepri_projection.html#type-projection">khepri_projection:projection()</a></code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-command_options">khepri:command_options()</a></code></li><li><code>Ret = ok | <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-error">khepri:error()</a></code></li></ul></p>
<p><code>StoreId</code>: the name of the Ra cluster.<br>
<code>PathPattern</code>: the pattern of tree nodes which should be projected.<br>
<code>Projection</code>: the projection record created with <a docgen-rel="seemfa" docgen-href="khepri_projection#new/3" href="khepri_projection.html#new-3"><code>khepri_projection:new/3</code></a>.<br>
<code>Options</code>: command options such as the command type.
 <br>
</p>
<p>returns: <code>ok</code> if the projection was registered, an <code>{error, Reason}</code> tuple
  otherwise.</p>
</div><p>Registers a projection.
 </p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
