<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module khepri_machine</title>
<link rel="stylesheet" type="text/css" href="github-markdown.css" title="EDoc">
<link href="prism.css" rel="stylesheet" /><style>
    body {
      box-sizing: border-box;
      min-width: 200px;
      max-width: 980px;
      margin: 0 auto;
      padding: 45px;
    }
    @media (max-width: 767px) {
      body {
        padding: 15px;
      }
    }
    /* Don't apply the table style to the top-level navigation bar. */
    .navbar table {
      display: table;
      width: 100%;
    }
    .navbar table tr,
    .navbar table th,
    .navbar table td {
      border: 0;
    }
    /* Keep the same font side inside code blocks than everywhere else. */
    .markdown-body pre code,
    code[class*="language-"] {
      font-size: 85%;
    }
    /* Force the color for link on code blocks used for @see tags.  */
    .markdown-body a code,
    .markdown-body a code span.token {
      color: var(--color-accent-fg);
    }
    /* Copy the style of code blocks. */
    .markdown-body .spec {
      background: #f5f2f0;
      padding: 1em;
      margin: .5em 0;
      overflow: auto;
      border-radius: 6px;
    }
    /* Improve margins inside function spec blocks so that:
        - empty paragraphs don't add useless margins
        - the final top and bottom margins are equal */
    .markdown-body .spec p,
    .markdown-body .spec ul {
      margin-top: 16px;
      margin-bottom: 0;
    }
    .markdown-body .spec p:first-child,
    .markdown-body .spec p:empty {
      margin-top: 0;
    }
    /* Put the function prototype in bold characters. */
    .markdown-body .spec > p > code:first-child {
      font-weight: bold;
    }
    /* Add some margin below the module short description between the table
       of contents in the Description section. This text isn't in a
       <p></p>. */
    .index + p {
      margin-top: 16px;
    }
    </style></head>
<body class="markdown-body language-erlang"><script src="prism.js"></script>
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module khepri_machine</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#types">Data Types</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>  
Khepri private low-level API.

<p><b>Behaviours:</b> <a href="ra_machine.html"><code>ra_machine</code></a>.</p>

<h2><a name="description">Description</a></h2><p>  
Khepri private low-level API.</p>
 
  <p>This module exposes the private "low-level" API to the Khepri database and
  state machine. Main functions correspond to Ra commands implemented by the
  state machine. All functions in <a docgen-rel="seeerl" docgen-href="khepri" href="khepri.html"><code>khepri</code></a> are built on top of this  
module.</p>
 
  This module is private. The documentation is still visible because it may
  help understand some implementation details. However, this module should
  never be called directly outside of Khepri.
<h2><a name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-keep_while_conds_map">keep_while_conds_map()</a></h3>
<p><code>keep_while_conds_map() = #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_path">khepri_path:native_path()</a> =&gt; <a href="/home/runner/work/khepri/khepri/doc/khepri_condition.html#type-native_keep_while">khepri_condition:native_keep_while()</a>}</code></p>
<p>  Per-node <code>keep_while</code> conditions.</p>

<h3 class="typedecl"><a name="type-keep_while_conds_revidx">keep_while_conds_revidx()</a></h3>
<p><code>keep_while_conds_revidx() = #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_path">khepri_path:native_path()</a> =&gt; #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_path">khepri_path:native_path()</a> =&gt; ok}}</code></p>
<p>  Internal reverse index of the keep_while conditions. If node A depends on a
  condition on node B, then this reverse index will have a "node B =&gt; node A"
  entry.</p>

<h3 class="typedecl"><a name="type-machine_config">machine_config()</a></h3>
<p><code>machine_config() = #config{store_id = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a>, snapshot_interval = non_neg_integer()}</code></p>
<p>  Configuration record, holding read-only or rarely changing fields.</p>

<h3 class="typedecl"><a name="type-stat">stat()</a></h3>
<p><code>stat() = #{payload_version := <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-payload_version">khepri:payload_version()</a>, child_list_version := <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-child_list_version">khepri:child_list_version()</a>}</code></p>
<p>  Stats attached to each node in the tree structure.</p>

<h3 class="typedecl"><a name="type-state">state()</a></h3>
<p><code>state() = #khepri_machine{config = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-machine_config">khepri_machine:machine_config()</a>, root = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-tree_node">khepri_machine:tree_node()</a>, keep_while_conds = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-keep_while_conds_map">khepri_machine:keep_while_conds_map()</a>, keep_while_conds_revidx = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-keep_while_conds_revidx">khepri_machine:keep_while_conds_revidx()</a>, triggers = #{<a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-trigger_id">khepri:trigger_id()</a> =&gt; #{sproc := <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_path">khepri_path:native_path()</a>, event_filter := <a href="/home/runner/work/khepri/khepri/doc/khepri_evf.html#type-event_filter">khepri_evf:event_filter()</a>}}, emitted_triggers = [<a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-triggered">khepri_machine:triggered()</a>], metrics = #{applied_command_count =&gt; non_neg_integer()}}</code></p>
<p>  State of this Ra state machine.</p>

<h3 class="typedecl"><a name="type-tree_node">tree_node()</a></h3>
<p><code>tree_node() = #node{stat = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-stat">khepri_machine:stat()</a>, payload = <a href="/home/runner/work/khepri/khepri/doc/khepri_payload.html#type-payload">khepri_payload:payload()</a>, child_nodes = #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-component">khepri_path:component()</a> := #node{stat = <a href="/home/runner/work/khepri/khepri/doc/khepri_machine.html#type-stat">khepri_machine:stat()</a>, payload = <a href="/home/runner/work/khepri/khepri/doc/khepri_payload.html#type-payload">khepri_payload:payload()</a>, child_nodes = #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-component">khepri_path:component()</a> := #node{}}}}}</code></p>
<p>  A node in the tree structure.</p>

<h3 class="typedecl"><a name="type-triggered">triggered()</a></h3>
<p><code>triggered() = #triggered{id = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-trigger_id">khepri:trigger_id()</a>, event_filter = <a href="/home/runner/work/khepri/khepri/doc/khepri_evf.html#type-event_filter">khepri_evf:event_filter()</a>, sproc = <a href="/home/runner/work/khepri/khepri/doc/khepri_fun.html#type-standalone_fun">khepri_fun:standalone_fun()</a>, props = map()}</code></p>


<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#get-3">get/3</a></td><td>Returns all tree nodes matching the path pattern.</td></tr>
<tr><td valign="top"><a href="#count-3">count/3</a></td><td>Counts all tree nodes matching the path pattern.</td></tr>
<tr><td valign="top"><a href="#delete-3">delete/3</a></td><td>Deletes all tree nodes matching the path pattern.</td></tr>
<tr><td valign="top"><a href="#transaction-4">transaction/4</a></td><td>Runs a transaction and returns the result.</td></tr>
<tr><td valign="top"><a href="#run_sproc-4">run_sproc/4</a></td><td>Executes a stored procedure.</td></tr>
<tr><td valign="top"><a href="#register_trigger-5">register_trigger/5</a></td><td>Registers a trigger.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="get-3">get/3</a></h3>
<div class="spec">
<p><code>get(StoreId, PathPattern, Options) -&gt; Result</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>PathPattern = <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern">khepri_path:pattern()</a></code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-query_options">khepri:query_options()</a></code></li><li><code>Result = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-result">khepri:result()</a></code></li></ul></p>
<p><code>StoreId</code>: the name of the Ra cluster.<br>
<code>PathPattern</code>: the path (or path pattern) to the nodes to get.<br>
<code>Options</code>: query options such as <code>favor</code>.
 <br>
</p>
<p>returns: an <code>{ok, Result}</code> tuple with a map with zero, one or more entries,
  or an <code>{error, Reason}</code> tuple.</p>
</div><p>Returns all tree nodes matching the path pattern.
 </p>

<h3 class="function"><a name="count-3">count/3</a></h3>
<div class="spec">
<p><code>count(StoreId, PathPattern, Options) -&gt; Result</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>PathPattern = <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern">khepri_path:pattern()</a></code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-query_options">khepri:query_options()</a></code></li><li><code>Result = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-ok">khepri:ok</a>(integer()) | <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-error">khepri:error()</a></code></li></ul></p>
<p><code>StoreId</code>: the name of the Ra cluster.<br>
<code>PathPattern</code>: the path (or path pattern) to the nodes to count.<br>
<code>Options</code>: query options such as <code>favor</code>.
 <br>
</p>
<p>returns: an <code>{ok, Count}</code> tuple with the number of matching tree nodes, or
  an <code>{error, Reason}</code> tuple.</p>
</div><p>Counts all tree nodes matching the path pattern.
 </p>

<h3 class="function"><a name="delete-3">delete/3</a></h3>
<div class="spec">
<p><code>delete(StoreId, PathPattern, Options) -&gt; Result</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>PathPattern = <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern">khepri_path:pattern()</a></code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-command_options">khepri:command_options()</a></code></li><li><code>Result = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-result">khepri:result()</a> | NoRetIfAsync</code></li><li><code>NoRetIfAsync = ok</code></li></ul></p>
<p><code>StoreId</code>: the name of the Ra cluster.<br>
<code>PathPattern</code>: the path (or path pattern) to the nodes to delete.<br>
<code>Options</code>: command options such as the command type.
 <br>
</p>
<p>returns: in the case of a synchronous delete, an <code>{ok, Result}</code> tuple with
  a map with zero, one or more entries, or an <code>{error, Reason}</code> tuple; in the
  case of an asynchronous put, always <code>ok</code> (the actual return value may be
  sent by a message if a correlation ID was specified).</p>
</div><p>Deletes all tree nodes matching the path pattern.
 </p>

<h3 class="function"><a name="transaction-4">transaction/4</a></h3>
<div class="spec">
<p><code>transaction(StoreId, Fun, ReadWrite, Options) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>Fun = <a href="/home/runner/work/khepri/khepri/doc/khepri_tx.html#type-tx_fun">khepri_tx:tx_fun()</a></code></li><li><code>ReadWrite = ro | rw | auto</code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-command_options">khepri:command_options()</a> | <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-query_options">khepri:query_options()</a></code></li><li><code>Ret = Atomic | Aborted | NoRetIfAsync</code></li><li><code>Atomic = {atomic, <a href="/home/runner/work/khepri/khepri/doc/khepri_tx.html#type-tx_fun_result">khepri_tx:tx_fun_result()</a>}</code></li><li><code>Aborted = <a href="/home/runner/work/khepri/khepri/doc/khepri_tx.html#type-tx_abort">khepri_tx:tx_abort()</a></code></li><li><code>NoRetIfAsync = ok</code></li></ul></p>
<p><code>StoreId</code>: the name of the Ra cluster.<br>
<code>Fun</code>: an arbitrary anonymous function.<br>
<code>ReadWrite</code>: the read/write or read-only nature of the transaction.<br>
<code>Options</code>: command options such as the command type.
 <br>
</p>
<p>returns: in the case of a synchronous transaction, <code>{atomic, Result}</code> where
  <code>Result</code> is the return value of <code>Fun</code>, or <code>{aborted, Reason}</code> if the
  anonymous function was aborted; in the case of an asynchronous transaction,
  always <code>ok</code> (the actual return value may be sent by a message if a
  correlation ID was specified).</p>
</div><p>Runs a transaction and returns the result.
 </p>

<h3 class="function"><a name="run_sproc-4">run_sproc/4</a></h3>
<div class="spec">
<p><code>run_sproc(StoreId, PathPattern, Args, Options) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>PathPattern = <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern">khepri_path:pattern()</a></code></li><li><code>Args = [any()]</code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-query_options">khepri:query_options()</a></code></li><li><code>Ret = any()</code></li></ul></p>
<p><code>StoreId</code>: the name of the Ra cluster.<br>
<code>PathPattern</code>: the path to the stored procedure.<br>
<code>Args</code>: the list of args to pass to the stored procedure; its length
         must be equal to the stored procedure arity.<br>
<code>Options</code>: options to tune the tree traversal or the returned structure
         content.
 <br>
</p>
<p>returns: the result of the stored procedure execution, or throws an
  exception if the node does not exist, does not hold a stored procedure or
  if there was an error.</p>
</div><p><p>Executes a stored procedure.</p>
 
  The stored procedure is executed in the context of the caller of <a docgen-rel="seemfa" docgen-href="#run_sproc/3" href="#run_sproc-3"><code>run_sproc/3</code></a>.
 </p>

<h3 class="function"><a name="register_trigger-5">register_trigger/5</a></h3>
<div class="spec">
<p><code>register_trigger(StoreId, TriggerId, EventFilter, StoredProcPath, Options) -&gt; Ret</code>
<ul class="definitions"><li><code>StoreId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-store_id">khepri:store_id()</a></code></li><li><code>TriggerId = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-trigger_id">khepri:trigger_id()</a></code></li><li><code>EventFilter = <a href="/home/runner/work/khepri/khepri/doc/khepri_evf.html#type-event_filter">khepri_evf:event_filter()</a> | <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern">khepri_path:pattern()</a></code></li><li><code>StoredProcPath = <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-path">khepri_path:path()</a></code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-command_options">khepri:command_options()</a></code></li><li><code>Ret = ok | <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-error">khepri:error()</a></code></li></ul></p>
<p><code>StoreId</code>: the name of the Ra cluster.<br>
<code>TriggerId</code>: the name of the trigger.<br>
<code>EventFilter</code>: the event filter used to associate an event with a
         stored procedure.<br>
<code>StoredProcPath</code>: the path to the stored procedure to execute when the
         corresponding event occurs.
 <br>
</p>
<p>returns: <code>ok</code> if the trigger was registered, an <code>{error, Reason}</code> tuple
  otherwise.</p>
</div><p>Registers a trigger.
 </p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
