<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module khepri_projection</title>
<link rel="stylesheet" type="text/css" href="edoc-extensions.css" title="EDoc">
<link rel="icon" href="khepri-favicon.svg" type="image/svg+xml">
</head>
<body class="markdown-body language-erlang"><script src="prism.js"></script>
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module khepri_projection</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#types">Data Types</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>Khepri projections.


<h2><a name="description">Description</a></h2><p>Khepri projections</p>
 
  <p>Projections build a replicated ETS table using tree nodes from the store
  which match a <a docgen-rel="seetype" docgen-href="khepri_path#pattern/0" href="khepri_path.html#type-pattern"><code>khepri_path:pattern()</code></a>. When a tree node matching a
  projection's pattern is changed in the store, the tree node is passed
  through the projection's <a docgen-rel="seetype" docgen-href="#projection_fun/0" href="#type-projection_fun"><code>projection_fun()</code></a> to create record(s).  
These records are then stored in the projection's ETS table for all members  
in a Khepri cluster.</p>
 
  <p>Projections provide a way to query the store as fast as possible and are  
appropriate for lookups which require low latency and/or high throughput.  
Projection tables contain all records matching the pattern, though, so the  
memory footprint of a projection table grows with the number of tree nodes in  
the store matching the pattern.</p>
 
  <p>Projection ETS tables are owned by the Khepri cluster and are deleted when  
the cluster stops.</p>
 
  Updates to projection tables are immediately consistent for the member of
  the cluster on which the change to the store is made and the leader member
  but are eventually consistent for all other followers.
<h2><a name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-extended_projection_fun">extended_projection_fun()</a></h3>
<p><code>extended_projection_fun() = fun((Table::<a href="/home/runner/work/khepri/stdlib/doc/ets.html#type-tid">ets:tid()</a>, Path::<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_path">khepri_path:native_path()</a>, OldPayload::<a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-node_props">khepri:node_props()</a>, NewPayload::<a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-node_props">khepri:node_props()</a>) -&gt; any())</code></p>
<p><p>  An extended projection function.</p>
 
  <p>In some cases, a tree node in the store might correspond to many objects in  
a projection table. Extended projection functions are allowed to call ETS  
functions directly in order to build the projection table.</p>
 
  <p><code>OldPayload</code> or <code>NewPayload</code> are empty maps if there is no tree node. For
  example, a newly created tree node will have an empty map for <code>OldPayload</code>
  and a <a docgen-rel="seetype" docgen-href="khepri#node_props/0" href="khepri.html#type-node_props"><code>khepri:node_props()</code></a> map with values for <code>NewPayload</code>.</p>
 
  <p>This function is compiled like a transaction function except that calls
  to the <a docgen-rel="seeerl" docgen-href="ets" href="ets.html"><code>ets</code></a> module are allowed.</p>
 
  The return value of this function is ignored.</p>

<h3 class="typedecl"><a name="type-options">options()</a></h3>
<p><code>options() = #{type =&gt; <a href="/home/runner/work/khepri/stdlib/doc/ets.html#type-table_type">ets:table_type()</a>, keypos =&gt; pos_integer(), read_concurrency =&gt; boolean(), write_concurrency =&gt; boolean() | auto, compressed =&gt; boolean()}</code></p>
<p><p>  Options which control the created ETS table.</p>
 
  <p>These options are a subset of the options available to <a docgen-rel="seemfa" docgen-href="ets#new/2" href="ets.html#new-2"><code>ets:new/2</code></a>.
  Refer to the <a docgen-rel="seemfa" docgen-href="ets#new/2" href="ets.html#new-2"><code>ets:new/2</code></a> documentation for a reference on each type  
and available values.</p>
 
  When a projection is created from a <a docgen-rel="seetype" docgen-href="#simple_projection_fun/0" href="#type-simple_projection_fun"><code>simple_projection_fun()</code></a>, the
  <code>type</code> option may only be <code>set</code> or <code>ordered_set</code>: <code>bag</code> types are not
  allowed. <a docgen-rel="seetype" docgen-href="#extended_projection_fun/0" href="#type-extended_projection_fun"><code>extended_projection_fun()</code></a>s may use any valid <a docgen-rel="seetype" docgen-href="ets#table_type/0" href="ets.html#type-table_type"><code>ets:table_type()</code></a>.</p>

<h3 class="typedecl"><a name="type-projection">projection()</a></h3>
<p><code>projection() = #khepri_projection{name = atom(), projection_fun = <a href="/home/runner/work/khepri/khepri/doc/khepri_fun.html#type-standalone_fun">khepri_fun:standalone_fun()</a>, ets_options = [atom() | tuple()]}</code></p>
<p>  A projection resource.
 </p>

<h3 class="typedecl"><a name="type-projection_fun">projection_fun()</a></h3>
<p><code>projection_fun() = <a href="#type-simple_projection_fun">simple_projection_fun()</a> | <a href="#type-extended_projection_fun">extended_projection_fun()</a></code></p>
<p><p>  A function that formats an entry in the tree into a record to be stored in a  
projection.</p>
 
  <p>Projection functions may either be "simple" or "extended." See <a docgen-rel="seetype" docgen-href="#simple_projection_fun/0" href="#type-simple_projection_fun"><code>simple_projection_fun()</code></a> and <a docgen-rel="seetype" docgen-href="#extended_projection_fun/0" href="#type-extended_projection_fun"><code>extended_projection_fun()</code></a> for more  
information.</p>
 
  The projection function is executed directly by the Ra server process. The
  function should be as simple and fast as possible to avoid slowing down the
  server.</p>

<h3 class="typedecl"><a name="type-simple_projection_fun">simple_projection_fun()</a></h3>
<p><code>simple_projection_fun() = fun((Path::<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_path">khepri_path:native_path()</a>, Payload::<a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-data">khepri:data()</a>) -&gt; Record::tuple())</code></p>
<p><p>  A simple projection function.</p>
 
  <p>Simple projection functions only take the path and payload for a tree node  
in the store. The record produced by the function is used to create and  
delete objects in the ETS table.</p>
 
  This function is compiled the same way as a transaction function: all
  side-effects are not allowed. Additionally, for any <code>Path</code> and <code>Payload</code>
  inputs, this function must consistently return the same <code>Record</code>.</p>

<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#new-2">new/2</a></td><td></td></tr>
<tr><td valign="top"><a href="#new-3">new/3</a></td><td>Creates a new projection data structure.</td></tr>
<tr><td valign="top"><a href="#name-1">name/1</a></td><td>Returns the name of the given <code>Projection</code>.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="new-2">new/2</a></h3>
<div class="spec">
<p><code>new(Name, ProjectionFun) -&gt; Projection</code>
<ul class="definitions"><li><code>Name = atom()</code></li><li><code>ProjectionFun = <a href="/home/runner/work/khepri/khepri/doc/khepri_projection.html#type-projection_fun">khepri_projection:projection_fun()</a></code></li><li><code>Projection = <a href="/home/runner/work/khepri/khepri/doc/khepri_projection.html#type-projection">khepri_projection:projection()</a></code></li></ul></p>
<p></p>
</div>
<p><b>See also:</b> <a href="khepri.html#register_projection-4">khepri:register_projection/4</a>, <a href="khepri_projection.html#new-3">khepri_projection:new/3</a>.</p>

<h3 class="function"><a name="new-3">new/3</a></h3>
<div class="spec">
<p><code>new(Name, ProjectionFun, Options) -&gt; Projection</code>
<ul class="definitions"><li><code>Name = atom()</code></li><li><code>ProjectionFun = <a href="/home/runner/work/khepri/khepri/doc/khepri_projection.html#type-projection_fun">khepri_projection:projection_fun()</a></code></li><li><code>Options = <a href="/home/runner/work/khepri/khepri/doc/khepri_projection.html#type-options">khepri_projection:options()</a></code></li><li><code>Projection = <a href="/home/runner/work/khepri/khepri/doc/khepri_projection.html#type-projection">khepri_projection:projection()</a></code></li></ul></p>
<p><code>Name</code>: the name of the projection. This corresponds to the name of
         the ETS table which is created when the projection is registered.<br>
<code>ProjectionFun</code>: the function which turns paths and data into records
         to be stored in the projection table.<br>
<code>Options</code>: options which control properties of the projection table.
 <br>
</p>
<p>returns: a <a docgen-rel="seetype" docgen-href="#projection/0" href="#type-projection"><code>projection()</code></a> resource.</p>
</div><p><p>Creates a new projection data structure.</p>
 
  This function throws an error in the shape of <code>{unexpected_option, Key,
  Value}</code> when an unknown or invalid <a docgen-rel="seetype" docgen-href="#option/0" href="#type-option"><code>option()</code></a> is passed. For example,
  if the passed <code>ProjectionFun</code> is a <a docgen-rel="seetype" docgen-href="#simple_projection_fun/0" href="#type-simple_projection_fun"><code>simple_projection_fun()</code></a> and the
  <code>Options</code> map sets the <code>type</code> to <code>bag</code>, this function throws
  <code>{unexpected_option, type, bag}</code> since <code>bag</code> is not valid for simple
  projection funs.
 </p>

<h3 class="function"><a name="name-1">name/1</a></h3>
<div class="spec">
<p><code>name(Projection) -&gt; Name</code>
<ul class="definitions"><li><code>Projection = <a href="#type-projection">projection()</a></code></li><li><code>Name = atom()</code></li></ul></p>
<p></p>
</div><p>Returns the name of the given <code>Projection</code>.</p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
