<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module khepri_condition</title>
<link rel="stylesheet" type="text/css" href="edoc-extensions.css" title="EDoc">
<link rel="icon" href="khepri-favicon.svg" type="image/svg+xml">
</head>
<body class="markdown-body language-erlang"><script src="prism.js"></script>
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module khepri_condition</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#types">Data Types</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>Condition support.


<h2><a name="description">Description</a></h2><p>Condition support.</p>
 
  <p>Conditions can be used in path patterns and <code>keep_while</code> conditions. They  
allow to point to a specific node only if conditions are met, or to match  
several tree nodes with a single path pattern.</p>
 
  <p>A condition is an Erlang record defining a specific property. Some of them  
have arguments to further define the condition.</p>
 
  <p>Path components (atoms and binaries) also act as conditions which check
  equality with the path of the tested node. This can be useful for
  conditions which compose other conditions: <a docgen-rel="seetype" docgen-href="#if_not/0" href="#type-if_not"><code>if_not()</code></a>,
  <a docgen-rel="seetype" docgen-href="#if_all/0" href="#type-if_all"><code>if_all()</code></a> and <a docgen-rel="seetype" docgen-href="#if_any/0" href="#type-if_any"><code>if_any()</code></a>.</p>
 
  <p>Example:</p>
 
  <pre><code>%% Matches `[stock, wood, &lt;&lt;"birch"&gt;&gt;]' but not `[stock, wood, &lt;&lt;"oak"&gt;&gt;]'
[stock, wood, #if_not{condition = &lt;&lt;"oak"&gt;&gt;}]</code></pre>
 
  All supported conditions are described in the <a href="#types">Data Types
  section</a>.
<h2><a name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-comparison_op">comparison_op()</a></h3>
<p><code>comparison_op(Type) = {eq, Type} | {ne, Type} | {lt, Type} | {le, Type} | {gt, Type} | {ge, Type}</code></p>
<p>  Comparison operator in some <a docgen-rel="seetype" docgen-href="#condition/0" href="#type-condition"><code>condition()</code></a>.</p>

<h3 class="typedecl"><a name="type-condition">condition()</a></h3>
<p><code>condition() = <a href="#type-if_name_matches">if_name_matches()</a> | <a href="#type-if_path_matches">if_path_matches()</a> | <a href="#type-if_has_payload">if_has_payload()</a> | <a href="#type-if_has_data">if_has_data()</a> | <a href="#type-if_has_sproc">if_has_sproc()</a> | <a href="#type-if_data_matches">if_data_matches()</a> | <a href="#type-if_node_exists">if_node_exists()</a> | <a href="#type-if_payload_version">if_payload_version()</a> | <a href="#type-if_child_list_version">if_child_list_version()</a> | <a href="#type-if_child_list_length">if_child_list_length()</a> | <a href="#type-if_not">if_not()</a> | <a href="#type-if_all">if_all()</a> | <a href="#type-if_any">if_any()</a></code></p>
<p>  All supported conditions.</p>

<h3 class="typedecl"><a name="type-if_all">if_all()</a></h3>
<p><code>if_all() = #if_all{conditions = [<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern_component">khepri_path:pattern_component()</a>]}</code></p>
<p><p>  Condition. Evaluates to true if all inner conditions evaluate to true.</p>
 
  Record fields:
  <ul>
  <li><code>conditions</code>: a list of inner conditions to evaluate.</li>
  </ul>
 
  Example:
  <pre><code>#if_all{conditions = [#if_name_matches{regex = "^a"},
                      #if_has_data{has_data = true}]}.</code></pre></p>

<h3 class="typedecl"><a name="type-if_any">if_any()</a></h3>
<p><code>if_any() = #if_any{conditions = [<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern_component">khepri_path:pattern_component()</a>]}</code></p>
<p><p>  Condition. Evaluates to true if any of the inner conditions evaluate to  
true.</p>
 
  Record fields:
  <ul>
  <li><code>conditions</code>: a list of inner conditions to evaluate.</li>
  </ul>
 
  Example:
  <pre><code>#if_any{conditions = [#if_name_matches{regex = "^a"},
                      #if_has_data{has_data = true}]}.</code></pre></p>

<h3 class="typedecl"><a name="type-if_child_list_length">if_child_list_length()</a></h3>
<p><code>if_child_list_length() = #if_child_list_length{count = non_neg_integer() | <a href="/home/runner/work/khepri/khepri/doc/khepri_condition.html#type-comparison_op">khepri_condition:comparison_op</a>(non_neg_integer())}</code></p>
<p><p>  Condition. Evaluates to true if the tested node's child list size  
corresponds to the expected value.</p>
 
  Record fields:
  <ul>
  <li><code>version</code>: integer or <a docgen-rel="seetype" docgen-href="#comparison_op/0" href="#type-comparison_op"><code>comparison_op()</code></a> to compare to the actual
  child list child.</li>
  </ul>
 
  Example:
  <pre><code>#if_child_list_length{count = 1}.
#if_child_list_length{count = {gt, 10}}.</code></pre></p>

<h3 class="typedecl"><a name="type-if_child_list_version">if_child_list_version()</a></h3>
<p><code>if_child_list_version() = #if_child_list_version{version = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-child_list_version">khepri:child_list_version()</a> | <a href="/home/runner/work/khepri/khepri/doc/khepri_condition.html#type-comparison_op">khepri_condition:comparison_op</a>(<a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-child_list_version">khepri:child_list_version()</a>)}</code></p>
<p><p>  Condition. Evaluates to true if the tested node's child list version  
corresponds to the expected value.</p>
 
  Record fields:
  <ul>
  <li><code>version</code>: integer or <a docgen-rel="seetype" docgen-href="#comparison_op/0" href="#type-comparison_op"><code>comparison_op()</code></a> to compare to the actual
  child list version.</li>
  </ul>
 
  Example:
  <pre><code>#if_child_list_version{version = 1}.
#if_child_list_version{version = {gt, 10}}.</code></pre></p>

<h3 class="typedecl"><a name="type-if_data_matches">if_data_matches()</a></h3>
<p><code>if_data_matches() = #if_data_matches{pattern = <a href="/home/runner/work/khepri/stdlib/doc/ets.html#type-match_pattern">ets:match_pattern()</a>, conditions = [any()], compiled = <a href="/home/runner/work/khepri/stdlib/doc/ets.html#type-comp_match_spec">ets:comp_match_spec()</a> | undefined}</code></p>
<p><p>  Condition. Evaluates to true if the tested node has a data payload and the
  data payload term matches the given <code>pattern</code> and all <code>conditions</code> evaluates  
to true.</p>
 
  Record fields:
  <ul>
  <li><code>pattern</code>: an ETS-like match pattern. The match pattern can define
  variables to be used in the <code>conditions</code> below.</li>
  <li><code>conditions</code>: a list of guard expressions. All guard expressions must
  evaluate to true to consider a match. The default is an empty list of
  conditions which means that only the pattern matching is
  considered.</li>
  </ul>
 
  Examples:
  <pre><code>%% The data must be of the form `{user, _}', so a tuple of arity 2 with the
%% first element being the `user' atom. The second element can be anything.
#if_data_matches{pattern = {user, '_'}}.</code></pre>
  <pre><code>%% The data must be of the form `{age, Age}' and `Age' must be an
%% integer greater than or equal to 18.
#if_data_matches{pattern = {age, '$1'},
                 conditions = [{is_integer, '$1'},
                               {'&gt;=', '$1', 18}]}.</code></pre>
 
  See <a href="https://www.erlang.org/doc/apps/erts/match_spec.html">Match
  Specifications in Erlang</a> for a detailed documentation of how it works.</p>

<h3 class="typedecl"><a name="type-if_has_data">if_has_data()</a></h3>
<p><code>if_has_data() = #if_has_data{has_data = boolean()}</code></p>
<p><p>  Condition. Evaluates to true if the tested node's data payload presence  
corresponds to the expected state.</p>
 
  Record fields:
  <ul>
  <li><code>has_data</code>: boolean set to the expected presence of a data
  payload.</li>
  </ul>
 
  <p>Data absence is either no payload or a non-data type of payload.</p>
 
  Example:
  <pre><code>#if_has_data{has_data = false}.</code></pre></p>

<h3 class="typedecl"><a name="type-if_has_payload">if_has_payload()</a></h3>
<p><code>if_has_payload() = #if_has_payload{has_payload = boolean()}</code></p>
<p><p>  Condition. Evaluates to true if the tested node has any kind of payload.</p>
 
  Record fields:
  <ul>
  <li><code>has_payload</code>: boolean set to the expected presence of any kind of
  payload.</li>
  </ul>
 
  Example:
  <pre><code>#if_has_payload{has_payload = true}.</code></pre></p>

<h3 class="typedecl"><a name="type-if_has_sproc">if_has_sproc()</a></h3>
<p><code>if_has_sproc() = #if_has_sproc{has_sproc = boolean()}</code></p>
<p><p>  Condition. Evaluates to true if the tested node's stored procedure payload  
presence corresponds to the expected state.</p>
 
  Record fields:
  <ul>
  <li><code>has_sproc</code>: boolean set to the expected presence of a stored procedure
  payload.</li>
  </ul>
 
  <p>Stored procedure absence is either no payload or a non-sproc type of  
payload.</p>
 
  Example:
  <pre><code>#if_has_sproc{has_sproc = false}.</code></pre></p>

<h3 class="typedecl"><a name="type-if_name_matches">if_name_matches()</a></h3>
<p><code>if_name_matches() = #if_name_matches{regex = any | iodata() | <a href="/home/runner/work/khepri/stdlib/doc/unicode.html#type-charlist">unicode:charlist()</a>, compiled = <a href="/home/runner/work/khepri/khepri/doc/khepri_condition.html#type-re_compile_ret">khepri_condition:re_compile_ret()</a> | undefined}</code></p>
<p><p>  Condition. Evaluates to true if the name of the tested node matches the  
condition pattern.</p>
 
  Record fields:
  <ul>
  <li><code>regex</code>: defines the condition pattern. It can be either:
  <ul>
  <li>a regular expression</li>
  <li>the atom <code>any</code> to match any node names; the equivalent of the <code>".*"</code>
  regular expression but more efficient</li>
  </ul></li>
  </ul>
 
  Example:
  <pre><code>#if_name_matches{regex = "^user_"}.
#if_name_matches{regex = any}.</code></pre></p>

<h3 class="typedecl"><a name="type-if_node_exists">if_node_exists()</a></h3>
<p><code>if_node_exists() = #if_node_exists{exists = boolean()}</code></p>
<p><p>  Condition. Evaluates to true if the tested node existence corresponds to  
the expected state.</p>
 
  Record fields:
  <ul>
  <li><code>exists</code>: boolean set to the expected presence of the node.</li>
  </ul>
 
  Example:
  <pre><code>#if_node_exists{exists = false}.</code></pre></p>

<h3 class="typedecl"><a name="type-if_not">if_not()</a></h3>
<p><code>if_not() = #if_not{condition = <a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-pattern_component">khepri_path:pattern_component()</a>}</code></p>
<p><p>  Condition. Evaluates to true if the inner condition evaluates to false.</p>
 
  Record fields:
  <ul>
  <li><code>condition</code>: the inner condition to evaluate.</li>
  </ul>
 
  Example:
  <pre><code>#if_not{condition = #if_name_matches{regex = "^a"}}.</code></pre></p>

<h3 class="typedecl"><a name="type-if_path_matches">if_path_matches()</a></h3>
<p><code>if_path_matches() = #if_path_matches{regex = any | iodata() | <a href="/home/runner/work/khepri/stdlib/doc/unicode.html#type-charlist">unicode:charlist()</a>, compiled = <a href="/home/runner/work/khepri/khepri/doc/khepri_condition.html#type-re_compile_ret">khepri_condition:re_compile_ret()</a> | undefined}</code></p>
<p><p>  Condition. Evaluates to true if the name of the tested node matches the  
condition pattern. If it does not match, child node names are tested  
recursively.</p>
 
  Record fields:
  <ul>
  <li><code>regex</code>: defines the condition pattern. It can be either:
  <ul>
  <li>a regular expression</li>
  <li>the atom <code>any</code> to match any node names; the equivalent of the <code>".*"</code>
  regular expression but more efficient</li>
  </ul></li>
  </ul>
 
  Example:
  <pre><code>#if_path_matches{regex = "^user_"}.
#if_path_matches{regex = any}.</code></pre></p>

<h3 class="typedecl"><a name="type-if_payload_version">if_payload_version()</a></h3>
<p><code>if_payload_version() = #if_payload_version{version = <a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-payload_version">khepri:payload_version()</a> | <a href="/home/runner/work/khepri/khepri/doc/khepri_condition.html#type-comparison_op">khepri_condition:comparison_op</a>(<a href="/home/runner/work/khepri/khepri/doc/khepri.html#type-payload_version">khepri:payload_version()</a>)}</code></p>
<p><p>  Condition. Evaluates to true if the tested node's payload version  
corresponds to the expected value.</p>
 
  Record fields:
  <ul>
  <li><code>version</code>: integer or <a docgen-rel="seetype" docgen-href="#comparison_op/0" href="#type-comparison_op"><code>comparison_op()</code></a> to compare to the actual
  payload version.</li>
  </ul>
 
  Example:
  <pre><code>#if_payload_version{version = 1}.
#if_payload_version{version = {gt, 10}}.</code></pre></p>

<h3 class="typedecl"><a name="type-keep_while">keep_while()</a></h3>
<p><code>keep_while() = #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-path">khepri_path:path()</a> =&gt; <a href="#type-condition">condition()</a>}</code></p>
<p><p>  An association between a path and a condition. As long as the condition  
evaluates to true, the tree node is kept. Once the condition evaluates to  
false, the tree node is deleted.</p>
 
  <p>If the <code>keep_while</code> conditions are false at the time of the insert, the
  insert fails. The only exception to that is if the <code>keep_while</code> condition  
is on the inserted node itself.</p>
 
  <p>Paths in the map can be native paths or Unix-like paths. However, having  
two entries that resolve to the same node (one native path entry and one  
Unix-like path entry for instance) is undefined behavior: one of them will  
overwrite the other.</p>
 
  Example:
  <pre><code>khepri:put(
  StoreId,
  [foo],
  Payload,
  #{keep_while =&gt; #{
    %% The node `[foo]' will be removed as soon as `[bar]' is removed
    %% because the condition associated with `[bar]' will not be true
    %% anymore.
    [bar] =&gt; #if_node_exists{exists = true}
  }}
).</code></pre></p>

<h3 class="typedecl"><a name="type-native_keep_while">native_keep_while()</a></h3>
<p><code>native_keep_while() = #{<a href="/home/runner/work/khepri/khepri/doc/khepri_path.html#type-native_path">khepri_path:native_path()</a> =&gt; <a href="#type-condition">condition()</a>}</code></p>
<p><p>  An association between a native path and a condition.</p>
 
  This is the same as <a docgen-rel="seetype" docgen-href="#keep_while/0" href="#type-keep_while"><code>keep_while()</code></a> but the paths in the map keys were
  converted to native paths if necessary.</p>

<h3 class="typedecl"><a name="type-re_compile_ret">re_compile_ret()</a></h3>
<p><code>re_compile_ret() = {ok, {re_pattern, term(), term(), term(), term()}} | {error, {string(), non_neg_integer()}}</code></p>
<p><p>  Return value of <a docgen-rel="seemfa" docgen-href="re#compile/1" href="re.html#compile-1"><code>re:compile/1</code></a>.</p>
 
  The opaque compiled regex type, <a docgen-rel="seetype" docgen-href="re#mp/0" href="re.html#type-mp"><code>re:mp()</code></a>, is unfortunately not
  exported by <a docgen-rel="seeerl" docgen-href="re" href="re.html"><code>re</code></a>, neither is the error tuple (at least up to
  Erlang/OTP 25.1).</p>

<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#ensure_native_keep_while-1">ensure_native_keep_while/1</a></td><td></td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="ensure_native_keep_while-1">ensure_native_keep_while/1</a></h3>
<div class="spec">
<p><code>ensure_native_keep_while(KeepWhile) -&gt; NativeKeepWhile</code>
<ul class="definitions"><li><code>KeepWhile = <a href="#type-keep_while">keep_while()</a></code></li><li><code>NativeKeepWhile = <a href="#type-native_keep_while">native_keep_while()</a></code></li></ul></p>
<p></p>
</div>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
